<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.devit.repository.BoardRepository">

	<!-- 게시글 업로드 -->
		<!-- <insert id="upload"> -->
		<insert id="upload" useGeneratedKeys="true" keyProperty="boardId">
			insert into board(user_id, title, content, type, count) 
			values(#{userId}, #{boardTitle}, #{boardContent}, #{boardType}, #{boardCount})
		</insert>
		
   <!--  게시글 조회 -->
      <select id="info" resultType="BoardResponse">
      
      	 update board
      	    set count = count + 1
      	  where board_id = #{bid};
      	  
         select a.board_id as boardId, 
         		a.user_id as userId, 
         		b.nickname as userName, 
         		a.title as boardTitle, 
         		a.content as boardContent, 
         		a.type as boardType, 
         		a.created as boardCreated, 
         		a.count as boardCount, 
         		a.modified as boardModified,
         		if(a.user_id = #{userId}, 'Y', 'N') as isMine
         from board a
		 left outer join user b on a.user_id = b.user_id
         where a.board_id = #{bid} and a.flag = 'Y';
      </select>
		
	<!--  게시글 삭제 -->
		<update id="delete">
			update board
			set flag = 'N', modified = now()
			where board_id = #{bid}
		</update>
		
	<!--  게시글 수정 -->
		<update id="update">
			update board
			set title = #{Board.boardTitle}, content = #{Board.boardContent}, type = #{Board.boardType}, count = #{Board.boardCount}, modified = now()
			where board_id = #{bid}
		</update>
		
		
	<!-- 게시글 목록 조회 -->
	      <select id="listinfo" resultType="BoardResponse">
         select a.board_id as boardId, 
         		a.user_id as userId, 
         		b.nickname as userName, 
         		a.title as boardTitle, 
         		a.content as boardContent, 
         		a.type as boardType, 
         		a.created as boardCreated, 
         		a.count as boardCount, 
         		a.modified as boardModified,
         		case when c.cnt is null then 0
                     when c.cnt = 0 then 0
                     else ceil(c.cnt/#{itemsperpage})
				end as pageCnt
           from board a
		        left outer join 
		        user b 
		        on 
		        a.user_id = b.user_id
                left outer join
                (
         		 select count(1) as cnt
         		   from board a
         		        left outer join
         		        user b
         		        on
         		        a.user_id = b.user_id
         		  where a.type = #{type}
            		and a.flag = 'Y'
            		<if test="searchtxt != null and searchtxt != ''">
						<if test="searchselect == '전체'">
						and (upper(a.title) like concat('%', upper(#{searchtxt}), '%') or
							upper(a.content) like concat('%', upper(#{searchtxt}), '%') or
							upper(b.nickname) like concat('%', upper(#{searchtxt}), '%')
							)
						</if>
						<if test="searchselect == '제목'">
						and upper(a.title) like concat('%', upper(#{searchtxt}), '%')
						</if>
						<if test="searchselect == '내용'">
						and upper(a.content) like concat('%', upper(#{searchtxt}), '%')
						</if>
						<if test="searchselect == '작성자'">
						and upper(b.nickname) like concat('%', upper(#{searchtxt}), '%')
						</if>
					</if>
				) c
				on
				1=1
          where a.type = #{type}
			<if test="searchtxt != null and searchtxt != ''">
				<if test="searchselect == '전체'">
				and (upper(a.title) like concat('%', upper(#{searchtxt}), '%') or
					upper(a.content) like concat('%', upper(#{searchtxt}), '%') or
					upper(b.nickname) like concat('%', upper(#{searchtxt}), '%')
					)
				</if>
				<if test="searchselect == '제목'">
				and upper(a.title) like concat('%', upper(#{searchtxt}), '%')
				</if>
				<if test="searchselect == '내용'">
				and upper(a.content) like concat('%', upper(#{searchtxt}), '%')
				</if>
				<if test="searchselect == '작성자'">
				and upper(b.nickname) like concat('%', upper(#{searchtxt}), '%')
				</if>
			</if>
            and a.flag = 'Y'
       order by a.board_id desc
		  limit #{startPage} , #{itemsperpage};
		  
      </select>
</mapper>