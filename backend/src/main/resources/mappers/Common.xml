<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.devit.repository.CommonRepository">
	
	<!-- 프로젝트 정보 검색 -->
	<select id="selectInfomationLectureBySearch" resultType="SearchInfoLectureResponse">
		 SELECT u.nickname,
				u.profile,
				l.lecture_id lectureId,
				l.title,
				l.content,
				l.thumbnail_url thumbnailUrl,
				l.view_count viewCount,
				l.type,
				(SELECT COUNT(1)
		           FROM lecture_like
				  WHERE like_flag = 'Y' AND lecture_id = l.lecture_id) likeCount,
				(SELECT COUNT(1)
				   FROM lecture_sub_index
				  WHERE lecture_id = l.lecture_id AND video_id IS NOT NULL AND lecture_sub_index.order != 0) AS lectureCount,
				tag.tag_name tagName,
				search.cnt totalCount,
				CASE WHEN EXISTS( SELECT 1
									FROM lecture_like
								   WHERE like_flag = 'Y' AND user_id = 8 AND l.lecture_id = lecture_id)
					 THEN TRUE
					 ELSE FALSE
				 END AS userLikeYn
		  FROM lecture l LEFT OUTER JOIN user u
						 ON l.user_id = u.user_id
						 LEFT OUTER JOIN (SELECT GROUP_CONCAT(tag_name) tag_name, common_id
											FROM lecture_tag
										GROUP BY common_id) tag
						 ON l.common_id = tag.common_id
						 CROSS JOIN (SELECT COUNT(1) AS cnt
											FROM lecture l
										 LEFT OUTER JOIN (SELECT GROUP_CONCAT(tag_name) tag_name, common_id
															FROM lecture_tag
														GROUP BY common_id) tag
										 ON l.common_id = tag.common_id
										 WHERE 1 = 1
										 			<foreach collection="searchText" item="text" index="index">
										 				AND (l.title LIKE CONCAT('%', #{text},'%')
											            OR l.content LIKE CONCAT('%', #{text},'%')
											            OR tag.tag_name LIKE CONCAT('%', #{text},'%'))
										 			</foreach>
										            ) search
		WHERE 1 = 1
			        <foreach collection="searchText" item="text" index="index">
			 				AND (l.title LIKE CONCAT('%', #{text},'%')
				            OR l.content LIKE CONCAT('%', #{text},'%')
				            OR tag.tag_name LIKE CONCAT('%', #{text},'%'))
		 			</foreach>
		ORDER BY viewCount DESC, likeCount DESC
		LIMIT #{startPage}, 20;
	</select>
	
	<!-- 목차 정보 검색 -->
	<select id="selectInfomationIndexBySearch" resultType="SearchInfoIndexResponse">
		 SELECT lsi.lecture_id lectureId,
				lsi.sub_id subId,
	            lsi.order,
	            lsi.title,
	            lsi.common_id commonId,
	            lsh.player_url playerUrl,
	            lsh.play_time playTime,
	            lsh.thumbnail_url thumbnailUrl,
	            lsh.view_count viewCount,
	            tag.tag_name tagName,
	            u.nickname,
	            u.profile,
	            (SELECT COUNT(1)
				   FROM lecture_sub_his_like
				  WHERE like_flag = 'Y' AND
						lecture_id = lsi.lecture_id AND
	                    sub_id = lsi.sub_id AND
	                    sub_his_id = lsh.sub_his_id) likeCount,
				CASE WHEN EXISTS( SELECT 1
								    FROM lecture_sub_his_like
								   WHERE like_flag = 'Y' AND user_id = #{userId} AND lsh.sub_his_id = sub_his_id)
						 THEN TRUE
						 ELSE FALSE
				 END AS userLikeYn,
	             c.cnt totalCount
		  FROM lecture_sub_index lsi
			   LEFT OUTER JOIN user u
			   ON lsi.user_id = u.user_id
	           LEFT OUTER JOIN (
						SELECT GROUP_CONCAT(tag_name) tag_name, common_id
	                      FROM lecture_tag
	                  GROUP BY common_id
	           ) tag
	           ON tag.common_id = lsi.common_id
	           LEFT OUTER JOIN lecture_sub_history lsh
	           ON lsh.lecture_id = lsi.lecture_id AND
	           lsh.sub_id = lsi.sub_id AND
	           lsi.video_id = lsh.sub_his_id
	           left outer join
	           lecture_sub_history lshw
	           ON lshw.lecture_id = lsi.lecture_id AND
	           lshw.sub_id = lsi.sub_id AND
	           lsi.wiki_id = lshw.sub_his_id
	           CROSS JOIN (
							SELECT COUNT(1) cnt
							 FROM lecture_sub_index lsi
	                         LEFT OUTER JOIN 
	                         (
									SELECT GROUP_CONCAT(tag_name) tag_name, common_id
									  FROM lecture_tag
								  GROUP BY common_id
						   ) tag
						   ON tag.common_id = lsi.common_id
						   LEFT OUTER JOIN lecture_sub_history lshw
						   ON lshw.lecture_id = lsi.lecture_id AND
						   lshw.sub_id = lsi.sub_id AND
							lsi.wiki_id = lshw.sub_his_id
						 WHERE 1 = 1 -- 아래 부분 반복문 필요
						 		<foreach collection="searchText" item="text" index="index">
					 				AND (lsi.title LIKE CONCAT('%', #{text},'%') OR
										 lshw.wiki_content LIKE CONCAT('%', #{text},'%') OR
										 tag.tag_name LIKE CONCAT('%', #{text},'%'))
					 			</foreach>
								) c
		 WHERE 1 = 1 -- 아래 부분 반복문 필요
			<foreach collection="searchText" item="text" index="index">
 				AND (lsi.title LIKE CONCAT('%', #{text},'%') OR
					 lshw.wiki_content LIKE CONCAT('%', #{text},'%') OR
					 tag.tag_name LIKE CONCAT('%', #{text},'%'))
 			</foreach>
		 ORDER BY lsh.view_count DESC, likeCount DESC
	     LIMIT #{startPage}, 20;
	</select>
	
   	<!-- 메인화면 데빗 현황 조회 -->
      <select id="getMainStatus" resultType="MainResponse">
      
		select concat(format(ifnull(u.totalUsers, 0), 0), '명') as totalUsers, 
			   concat(format(ifnull(d.totalDeviters, 0), 0), '명') as totalDeviters, 
	           concat(format(ifnull(l.totalLectures, 0), 0), '강의') as totalLectures
	      from (
				select 1
	              from dual
			   ) a
			   left outer join
	           (
				select count(1) as totalUsers
				  from user
			   ) u
	           on
	           1=1
			   left outer join
	           (
	            select count(1) as totalDeviters
	              from lecture_sub_history 
				 where accept_yn = 'Y'
			  group by user_id
	           ) d
	           on
	           1=1
	           left outer join
	           (
	            select count(1) as totalLectures
	              from lecture
				 where deleted_flag = 'N'
	           ) l
	           on
	           1=1;
      </select>
</mapper>